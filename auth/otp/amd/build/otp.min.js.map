{"version":3,"file":"otp.min.js","sources":["../src/otp.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"Actions\" panel at the bottom of the page.\n *\n * @module     auth_otp/otp\n * @copyright  2021 Brain station 23 <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function ($, Ajax, Notification, str) {\n\n    $(\"#sendotp\").click(function (e) {\n        $('#sendotp').attr('disabled', 'disabled');\n        var fullphone =  $('#phone').val();\n        $('input[name=\"full_number\"]').val(fullphone);\n        var phone = $('#phone').val();\n        // ;\n        if (phone) {\n            // alert(fullphone);\n            var phoneno = /^09[0-9]{9}$/;\n            if (phoneno.test(fullphone)) {\n                let timerOn = true;\n                function timer(remaining) {\n                    var m = Math.floor(remaining / 60);\n                    var s = remaining % 60;\n                    m = m < 10 ? '0' + m : m;\n                    s = s < 10 ? '0' + s : s;\n                    document.getElementById('timer').innerHTML = m + ':' + s;\n                    remaining -= 1;\n                    if (remaining >= 0 && timerOn) {\n                        setTimeout(function () {\n                            timer(remaining);\n                        }, 1000);\n                        return;\n                    }\n                    if (!timerOn) {\n                        // Do validate stuff here\n                        return;\n                    }\n                    // Do timeout stuff here\n                    $('#sendotp').removeAttr('disabled');\n                    document.getElementById('timer').innerHTML = 'Resend Code';\n                    $('#sendotp').removeClass('d-none');\n                }\n                // API Call\n                var wsfunction = 'auth_otp_send_sms';\n                var params = {\n                    'phone': phone,\n                };\n\n                var request = {\n                    methodname: wsfunction,\n                    args: params\n                };\n\n                try {\n                    Ajax.call([request])[0].done(function (data) {\n                        if (data.success == 1) {\n                            $('#otp-field').removeClass('d-none');\n                            $('#sendotp').attr('disabled', 'disabled');\n                            $('#phone').attr('disabled', 'disabled');\n                            $('#phone').val(phone);\n                            $('#username').val(data.username);\n                            timer(300);\n\n                            Notification.addNotification({\n                                message: data.message,\n                                type: 'success'\n                            });\n\n                        } else {\n                            $('#sendotp').removeAttr('disabled');\n                            Notification.addNotification({\n                                message: data.message,\n                                type: 'error'\n                            });\n                        }\n                    }).fail(Notification.exception);\n                } catch (e) {\n                    console.log(e);\n                    $('#sendotp').removeAttr('disabled');\n                }\n            } else {\n                 $('#sendotp').removeAttr('disabled');\n                str.get_string('invalidphonenumber', 'auth_otp').done(function (s) {\n                    Notification.addNotification({\n                        message: s,\n                        type: 'error'\n                    });\n                }).fail(Notification.exception);\n            }\n        } else {\n             $('#sendotp').removeAttr('disabled');\n            str.get_string('phonenumberempty', 'auth_otp').done(function (s) {\n                Notification.addNotification({\n                    message: s,\n                    type: 'error'\n                });\n            }).fail(Notification.exception);\n\n        }\n        return false;\n    });\n});\n"],"names":["define","$","Ajax","Notification","str","click","e","attr","fullphone","val","phone","test","timerOn","timer","remaining","m","Math","floor","s","document","getElementById","innerHTML","setTimeout","removeAttr","removeClass","request","methodname","args","call","done","data","success","username","addNotification","message","type","fail","exception","console","log","get_string"],"mappings":";;;;;;;;AAuBAA,sBAAO,CAAC,SAAU,YAAa,oBAAqB,aAAa,SAAUC,EAAGC,KAAMC,aAAcC,KAE9FH,EAAE,YAAYI,OAAM,SAAUC,GAC1BL,EAAE,YAAYM,KAAK,WAAY,gBAC3BC,UAAaP,EAAE,UAAUQ,MAC7BR,EAAE,6BAA6BQ,IAAID,eAC/BE,MAAQT,EAAE,UAAUQ,SAEpBC,MAAO,IAEO,eACFC,KAAKH,WAAY,KACrBI,SAAU,WACLC,MAAMC,eACPC,EAAIC,KAAKC,MAAMH,UAAY,IAC3BI,EAAIJ,UAAY,GACpBC,EAAIA,EAAI,GAAK,IAAMA,EAAIA,EACvBG,EAAIA,EAAI,GAAK,IAAMA,EAAIA,EACvBC,SAASC,eAAe,SAASC,UAAYN,EAAI,IAAMG,GACvDJ,WAAa,IACI,GAAKF,QAClBU,YAAW,WACPT,MAAMC,aACP,KAGFF,UAKLX,EAAE,YAAYsB,WAAW,YACzBJ,SAASC,eAAe,SAASC,UAAY,cAC7CpB,EAAE,YAAYuB,YAAY,eAQ1BC,QAAU,CACVC,WANa,oBAObC,KANS,OACAjB,YASTR,KAAK0B,KAAK,CAACH,UAAU,GAAGI,MAAK,SAAUC,MACf,GAAhBA,KAAKC,SACL9B,EAAE,cAAcuB,YAAY,UAC5BvB,EAAE,YAAYM,KAAK,WAAY,YAC/BN,EAAE,UAAUM,KAAK,WAAY,YAC7BN,EAAE,UAAUQ,IAAIC,OAChBT,EAAE,aAAaQ,IAAIqB,KAAKE,UACxBnB,MAAM,KAENV,aAAa8B,gBAAgB,CACzBC,QAASJ,KAAKI,QACdC,KAAM,cAIVlC,EAAE,YAAYsB,WAAW,YACzBpB,aAAa8B,gBAAgB,CACzBC,QAASJ,KAAKI,QACdC,KAAM,cAGfC,KAAKjC,aAAakC,WACvB,MAAO/B,GACLgC,QAAQC,IAAIjC,GACZL,EAAE,YAAYsB,WAAW,kBAG5BtB,EAAE,YAAYsB,WAAW,YAC1BnB,IAAIoC,WAAW,qBAAsB,YAAYX,MAAK,SAAUX,GAC5Df,aAAa8B,gBAAgB,CACzBC,QAAShB,EACTiB,KAAM,aAEXC,KAAKjC,aAAakC,gBAGxBpC,EAAE,YAAYsB,WAAW,YAC1BnB,IAAIoC,WAAW,mBAAoB,YAAYX,MAAK,SAAUX,GAC1Df,aAAa8B,gBAAgB,CACzBC,QAAShB,EACTiB,KAAM,aAEXC,KAAKjC,aAAakC,kBAGlB"}