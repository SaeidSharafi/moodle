<?php

require_once('../../config.php');
require_once $CFG->dirroot.'/course/lib.php';
global $USER;
$systemcontext = context_system::instance();
if (!has_capability('moodle/site:config', $systemcontext) && $USER->id != "14334") {
    header('Location: '.$CFG->wwwroot);
    return;
}
header("X-Accel-Buffering: no");
ob_implicit_flush();
echo "Starting Process";

$crs['omran'] = [
    '0-4433550', '1-4433636', '2-4433636', '1-4422882', '2-4422882', '3-4422882', '0-2335136', '1-2335150',
    '1-4422779', '0-4433638', '2-4422920', '1-2333135', '2-2333135', '1-4422892', '0-4433637', '0-4433810', '1-4422868',
    '2-4422868', '3-4422868', '0-2335137', '1-4422803', '0-4433811', '0-4433647', '1-4422871', '2-4422871', '0-2335138',
    '1-4422891', '1-4433806', '2-4433806', '1-4422884', '0-4433635', '0-2333081', '1-4422904', '1-4422890', '2-4422890',
    '0-4433645', '1-4433807', '2-4433807', '1-4422810', '2-4422810', '0-2335142', '1-4422921', '1-4433808', '2-4433808',
    '1-4422997', '2-4422997', '1-4422893', '0-4433149', '0-4433163', '1-4422837', '2-4422837', '1-2335146'
];
$crs['eqtesad'] = [
    '1-214128', '0-214133', '1-214120', '1-214140', '1-214136', '1-214138', '1-214143', '0-214159', '0-214165',
    '0-214154', '0-214132', '0-214137', '0-214128', '0-214133', '0-214120', '0-214136', '0-214143', '0-214159',
    '0-214165', '0-214154', '1-235132', '1-235117', '1-235122', '1-235133', '1-235128', '1-235140', '1-235155',
    '1-235124', '1-235127', '1-235129'
];
$crs['shimi'] = [
    '1-600132', '2-600132', '3-600132', '0-600134', '0-600133', '0-608107', '0-608112', '1-600123', '2-600123',
    '0-608104', '0-608101', '0-608103', '1-6034595', '0-6034594', '0-6031157', '1-600121', '2-600121', '1-600130',
    '2-600130', '3-600130', '0-600122', '0-600131', '1-600127', '2-600127', '3-600127', '0-614102', '0-614108',
    '0-608106', '1-600153', '0-600147', '1-600135', '2-600135', '3-600135', '0-6034597', '1-614104', '2-614104',
    '0-6034512', '1-6034528', '1-600160', '2-600160', '0-600145'
];
$crs['rava'] = [
    '1-707110', '2-707110', '1-707108', '2-707109', '1-707134', '2-707134', '1-707186', '2-707186', '1-707140',
    '2-707140', '1-707180', '2-707180', '1-707148', '1-707151', '1-707146', '3-707146', '2-707173', '2-707174',
    '2-707176', '0-710134', '0-710137', '0-710154', '0-710136', '0-710142', '0-710145', '0-710148', '0-710151',
    '0-710151', '0-710151', '0-710151', '0-710151', '0-710151', '0-710151', '0-710151', '0-710151', '0-710151',
    '0-722156', '0-722135', '0-722117', '0-722126', '0-722118', '0-722130', '0-722103', '0-722149', '0-722149',
    '0-722149', '0-722149', '0-722149', '0-722149', '0-722138'
];
$crs['physic'] = [
    '1-616129', '1-6021027', '1-616120', '1-616132', '2-616116', '1-616116', '1-6021028', '1-6021034', '3-6021023',
    '2-6021023', '1-6021023', '1-6021050', '1-6021042', '1-6021059', '1-6021029', '3-6022028', '2-6022028', '1-6022028',
    '1-616202', '1-616152', '1-616189', '1-6025106', '2-6020467', '1-6020467', '2-616136', '1-616136', '1-6021055',
    '1-6021043', '1-6025453', '1-6021048'
];
$crs['adabiat'] = [
    '103-1192777', '103-1192299', '103-1192282', '103-1192266', '103-1193035', '103-1192996', '103-1192363',
    '103-1192217', '103-1192193', '103-1192103', '103-1193027', '103-1192882', '102-1362958', '102-1363374',
    '102-1362488', '102-1362999', '102-1362285', '102-1363013', '102-1363005', '102-1363095', '102-8888289',
    '102-1363054', '102-1362333', '102-1362503', '102-1362941', '102-1363079', '11-1023152', '11-1023141', '11-1023125',
    '11-1023162', '11-1023132', '11-1023143', '11-1023165', '11-1022017', '11-1023144', '14-1102819', '14-1102839',
    '14-1102823', '14-1102833', '14-1102822', '14-1102846', '106-106147', '106-106120', '106-106161', '106-106153',
    '106-106119', '106-106117', '106-106125', '106-106134'
];
$crs['dam'] = [
    '1-84188194', '2-84188194', '1-84188195', '2-84188195', '1-84188198', '2-84188198', '1-84188192', '2-84188192',
    '1-84188193', '2-84188193', '1-84188197', '2-84188197', '1-84188196', '2-84188196', '1-84183292', '1-8418892',
    '1-84184735', '2-84184735', '1-84188208', '1-84188137', '2-84188137', '1-84188206', '2-84188206', '1-84186980',
    '2-84186980', '1-84188207', '1-84188205', '2-84188205', '1-84188146', '2-84188146', '1-84188218', '1-84188219',
    '1-84188220', '1-84188221', '1-84188222', '1-84188223', '1-84188161', '2-84188161', '1-84188224', '1-84188225',
    '1-84188226', '1-84188233', '2-84188233', '1-84188209', '1-8418000', '1-84188169', '2-84188169', '3-84188169',
    '4-84188169', '5-84188169', '1-84188170', '2-84188170', '3-84188170', '4-84188170', '5-84188170', '1-84188171',
    '2-84188171', '3-84188171', '4-84188171', '5-84188171', '1-84188172', '2-84188172', '3-84188172', '4-84188172',
    '5-84188172', '1-84188173', '2-84188173', '3-84188173', '4-84188173', '5-84188173', '1-84188174', '2-84188174',
    '3-84188174', '4-84188174', '5-84188174', '1-84188175', '2-84188175', '3-84188175', '4-84188175', '5-84188175',
    '1-8418000', '1-1660140', '2-1660140', '1-1660136', '1-1660133', '2-1660133', '1-1660141', '2-1660141', '1-1660145',
    '1-1660143', '2-1660143', '1-1660125', '1-1660138'
];
$crs['computer'] = [
    '1-500133', '2-500133', '1-500135', '2-500135', '3-500135', '4-500135', '1-500136', '2-500136', '3-500136',
    '4-500136', '5-500136', '0-512008', '1-512010', '2-512010', '1-500132', '2-500132', '3-500132', '4-500132',
    '5-500132', '6-500132', '0-511008', '1-500134', '2-500134', '3-500134', '4-500134', '5-500134', '6-500134',
    '1-527011', '2-527011', '1-527008', '1-526011', '1-526010', '5-513095', '6-513103', '1-513111', '2-513111',
    '3-513111', '4-513111', '0-500124', '0-512004', '0-512005', '0-512007', '0-512017', '0-511006', '1-511004',
    '1-511004', '2-511004', '0-511003', '0-511020', '0-511021', '0-511013', '0-511015', '0-511017', '0-527005',
    '0-527012', '0-527019', '0-527020', '0-527004', '0-527014', '0-527016', '0-526005', '0-526021', '0-512013',
    '0-526012', '0-526006', '0-526013', '0-539337', '0-539329', '0-539370', '0-539335', '0-539314', '0-539340',
    '0-539320', '0-539373', '1-513127', '2-513127', '1-513142', '2-513142', '1-513104', '2-513104', '1-513113',
    '2-513113', '1-513134', '2-513134', '1-513147', '2-513147', '1-513146', '2-513146', '1-513120', '2-513120',
    '1-513138', '2-513138'
];
$crs['hoqoq'] = [
    '3-2232168', '1-2232427', '1-2232565', '1-2232581', '1-2232581', '1-2232621', '3-2232621', '1-2232719', '1-2092321',
    '1-2092321', '1-2092419', '1-2092524', '1-2092987', '2-2092995', '2-2093057', '1-2093062', '1-2093063', '1-2093073',
    '1-2093075', '1-2093077', '1-2093080', '1-2093083', '1-2093092', '1-2093096', '1-20298312', '1-20298313',
    '1-20298323', '2-20298328', '1-20298333', '1-20298347', '1-20298348', '1-20298349', '1-20298363', '1-260116',
    '1-260124', '1-260129', '1-260135', '1-260136', '1-260139', '1-260142', '1-260149', '1-260159'
];
$crs['mechanic'] = [
    '2-4612256', '3-4612256', '4-4612256', '331-4612256', '332-4612256', '2-4612394', '1-4612401', '3-4612401',
    '4-4612401', '1-4612442', '1-4612483', '1-4612491', '1-4612515', '1-4612523', '2-4612564', '3-4612572', '4-4612572',
    '1-4612612', '1-4612694', '1-4612775', '1-4612945', '1-4613058', '1-4613066', '1-4613244', '1-4622965', '3-4622965',
    '1-4623215', '521-1001073', '421-1001067', '1-4633138', '2-4633138', '1-4633227', '1-4633235', '1-4633268',
    '2-4633268', '1-4633746', '1-4633779', '1-4633908', '1-4633916', '1-4633932', '1-4633957', '2-4633957', '1-4634045',
    '1-4634053', '2-4634053', '422-1001073', '1-4843063', '1-4843109', '1-4843268', '1-4843382', '2-4843382',
    '1-4843457', '1-4843602', '1-4843611', '1-4843716', '1-4843795', '1-4843814', '1-4843827', '16-4742691',
    '26-4742764', '26-4743177', '261-4743185', '262-4743185', '16-4743510', '28-4743511', '16-4743512', '26-4743515',
    '26-4743518', '26-4743521', '28-4743523', '26-4743524', '28-4743529', '18-4743530', '18-4743531', '16-4743537',
    '18-4743539', '18-4743543', '16-4743546', '26-4743548'
];
$crs['olom'] = [
    '1-6042513', '1-6040901', '1-6040918', '1-6043382', ' 1-6049983', '1-6042968',
    '1-6042384', '-6043353', '1-6043354', '1-6043402', '2-6043382', '2-6049983', '2-6043430',
    '2-6043363', '2-6040723', '2-6043379', '2-6043424', '3-6044044', '3-6043384', '3-6043385',
    '3-6043386', '3-6043373', '3-6040756', '3-6043374', '3-6043383', '4-612151', '4-612150',
    '4-612129', '4-612121', '4-612122', '4-612127', '4-612128', '4-612140', '4-612135'
];
$crs['barname'] = [
    '1-20021911', '1-20021914', '1-20021915', '1-20021917', '1-20021919', '1-20021922', '1-20021924', '1-20022011',
    '1-20022012', '1-20022015', '1-20022016', '1-20022017', '1-20022020', '1-20022024'
];
$crs['marand'] = [
    '3-522536', '3-522540', '3-522553', '4-522557', '4-522580', '4-522587', '3-522588', '3-522589', '3-522590',
    '1-5226104', '1-5226105', '13-5226106', '1-5226108', '11-5226109', '12-5226109', '1-5226110', '11-5226111',
    '12-5226111', '1-5226117', '2-5226117', '1-5226122', '1-5226130', '1-522625', '11-522626', '12-522626', '1-522685',
    '11-522686', '12-522686', '1-5228100', '1-522819', '1-522853', '4-522857', '1-522876', '1-522887', '3-522889',
    '3-522890', '3-522891', '3-522894', '3-522895', '3-522896', '3-522897'
];
$crs['keshavarzi'] = [
    '990-50222376', '991-50222376', '992-50222376', '993-50222376', '991-50222490', '991-50222497', '991-50222497',
    '880-50222502', '991-50222502', '991-50222502', '991-50222503', '991-50222504', '991-50222504', '991-50222505',
    '1-5022473', '2-5022473', '3-5022473', '4-5022473', '411-5312129', '411-5312129', '1-5312138', '411-5312138',
    '411-5312138', '880-5312138', '411-5312141', '411-5312141', '1-5312145', '2-5312145', '3-5312145', '4-5312145',
    '5-5312145', '6-5312145', '7-5312145', '8-5312145', '9-5312145', '10-5312145', '11-5312145', '12-5312145',
    '13-5312145', '14-5312145', '15-5312145', '16-5312145', '17-5312145', '410-5312153', '410-5312841', '410-5313587',
    '411-5313640', '880-5313640', '411-5313668', '880-5313668', '411-5222242', '411-5313546', '480-5322028',
    '481-5322038', '491-5322114', '491-5322114', '880-5322114', '481-5322118', '481-5322118', '490-5322128',
    '490-5322129', '490-5322129', '490-5322130', '490-5322132', '490-5322132', '481-5323261', '481-5323261',
    '480-5323606', '480-5323606', '480-5324022', '480-5324022', '481-5324023', '490-5324094', '490-5324094',
    '880-5324094', '490-5324095', '880-5324095', '490-5324096', '880-5324096', '471-5212214', '471-5212214',
    '470-5232805', '471-5233867', '472-5233867', '472-5233867', '471-5233871', '470-5233874', '471-5233875',
    '471-5233876', '471-5233876', '470-5233877', '471-5233878', '471-5233888', '470-5242170', '880-5242173',
    '471-5233887', '470-5252318', '461-437104', '461-437104', '461-437112', '461-437112', '461-437116', '460-437117',
    '460-437120', '460-437125', '460-437125', '460-437126', '461-5212182', '461-5212182', '880-5212182', '461-5212255',
    '461-5212255', '460-5242641', '461-5322642', '1-430102', '3-430102', '4-430102', '5-430102', '6-430102', '7-430102',
    '8-430102', '9-430102', '10-430102', '11-430102', '451-5412021', '451-5412021', '451-5412121', '451-5412121',
    '880-5412121', '451-5412244', '450-5412270', '880-5412270', '451-5412285', '451-5412285', '1-5413808',
    '450-5413808', '450-5413808', '880-5413808', '450-5413900', '450-5413989', '450-5413996', '430-5222036',
    '431-5222037', '431-5222259', '431-5222259', '880-5222259', '431-5222323', '431-5222323', '431-5223674',
    '431-5223675', '431-5223675', '431-5223677', '430-5223680', '880-5223680', '431-5323924', '400-5252023',
    '400-5252024', '401-5252025', '400-5252853', '400-5252853', '400-5252861', '400-5252861', '400-5252918',
    '400-5252918', '400-5252959', '400-5252959', '401-5253408', '421-5242546', '421-5242546', '880-5242546',
    '420-5243756', '420-5243756', '420-5243757', '420-5243757', '421-5243758', '421-5243759', '421-5243761',
    '421-5243763', '421-5243763', '421-5243771', '421-5243771', '421-50222489', '421-50222484', '420-50222488'
];
$crs['tarbiat'] = [
    '1-764123', '1-764130', '1-764161', '1-764162', '1-764203', '2-764203', '3-764203', '1-764173', '1-764175',
    '2-764175', '1-764141', '2-764141', '1-764139', '1-764150', '2-764150', '3-764150', '1-764102',
    '1-764132', '1-764115', '1-764134', '2-764134', '3-764134', '3-764141', '2-764139', '3-764139', '1-764142',
    '2-764143', '3-764143', '1-764145', '2-764145', '3-764145', '1-764149', '2-764149', '3-764149'
];
$crs['miane'] = [
    '151163-151163', '142033-14203', '1411455-141145', '142044-14204', '151161-151161', '151153-151153',
    '1411477-141147', '151160-151160', '142011-14201', '1411733-141173', '151172-151172', '151169-151169',
    '151190-151190', '1411411-141141', '151184-151184', '1811177-181117', '14111477-1411147', '141177777-14117777',
    '151170-151170', '151176-151176', '1411400-141140'
];
$crs['karafarini'] = [
    '1-214128', '0-214133', '1-214120', '1-214140', '1-214136', '1-214138', '1-214143', '0-214159', '0-214165',
    '0-214154', '0-214132', '0-214137', '0-214128', '0-214133', '0-214120', '0-214136', '0-214143', '0-214159',
    '0-214165', '0-214154', '1-235132', '1-235117', '1-235122', '1-235133', '1-235128', '1-235140', '1-235155',
    '1-235124', '1-235127', '1-235129'
];
$crs['maaref'] = [
    '1-8888703', '8-8888703', '10-8888703', '6-8888703', '7-888703', '11-8888703', '19-8888703', '21-8888703',
    '2-8888702', '4-8888702', '6-8888702', '11-8888702', '13-8888702', '7-8888700', '8-8888700', '1-8888704',
    '2-8888704', '3-8888704', '10-8888704', '9-8888704', '5-8888704', '7-8888704', '6-8888704', '13-8888704',
    '15-8888704', '14-8888704', '20-8888704', '1-8888705', '13-8888705', '1-8888706', '2-8888706', '3-8888706',
    '4-8888706', '5-8888706', '8-8888706', '7-8888706', '6-8888706', '9-8888706', '12-8888706', '10-8888706',
    '11-8888706', '13-8888706', '14-8888706', '15-8888706', '16-8888706', '17-8888706', '19-8888706', '18-8888706',
    '20-8888706'
];
$crs['alahiat'] = [
    '9812-98125129', '9812-98125109', '9812-98125123', '9812-98125126', '9812-98125102', '9812-9812594',
    '9812-98125122', '9812-98125119', '9812-98125107', '9812-98125110'
];

$crs['seminar'] = [
    '5-1404242', '55-1404242', '555-1404242', '1-1404531', '1-1404544', '1-1404653', '1-1404657', '11-1404657',
    '111-1404657', '1111-1404657', '11111-1404657', '111111-1404657', '1-1404737', '4-1404743', '44-1404743',
    '444-1404743', '4-1405019', '4-1405306', '4-1405314', '4-1405640', '4-1405774', '1-1405777', '1-1405778',
    '1-1405779', '2-1406101', '2-1406103', '22-1406103', '222-1406103', '2222-1406103', '2-1406811', '2-1406845',
    '5-14069903', '2-14069904', '5-1407712', '5-1415023', '5-1415024', '2-1416112', '1245-8888701', '1-1404001',
    '1245-1404013', '1-1404531', '1-1404544', '1-1404650', '1-1404658', '1-1404737', '4-1405307', '4-1405309',
    '4-1405310', '4-1405630', '4-1405773', '1-1405781', '2-1406002', '5-1406842', '2-1406859', '2-14069905',
    '2-14069908', '5-1407712', '5-1407713', '5-1415013', '5-1415028', '2-1416825', '5-1417015', '420-50222488',
    '421-50222489', '421-5243761', '1-1404001'
];
foreach ($crs as $course) {
    switch_cat($course);
}

function switch_cat($array)
{
    global $DB;
    try {
        $term = '14002';
        $term_alt = '14002ALT';
        foreach ($array as $cid) {
            echo "******", $cid, "******", "<br>";
            $lesson_group = explode('-', $cid)[0];
            $course = $DB->get_record('course', ['idnumber' => "14002-{$cid}"]);
            if (!$course) {
                $course = $DB->get_record_sql("SELECT * FROM {course} WHERE shortname LIKE '%-14002-{$cid}';");
            }

            if (!$course) {
                echo "{$cid} یافت نشد "."<br>";
                echo "===================================================", "<br>";
                continue;
            }
            $category = $DB->get_record('course_categories', array('id' => $course->category));

            if (strpos($category->idnumber, 'ALT') !== false) {
                echo "{$cid} نیازی به انتقال ندارد."."<br>";
                continue;
            }

            $cat_path = explode('/', $category->path);

            $faculty_catid = $cat_path[2];
            $faculty_category = $DB->get_record('course_categories', array('id' => $faculty_catid));
            $facualty_code = str_replace($term.'10', '', $faculty_category->idnumber);
            $tcode = 'TRM'.$term_alt;
            $fcode = $term_alt.'10'.$facualty_code;
            echo "-----------------------", "<br>";
            echo $faculty_category->idnumber, " : ", $faculty_category->name, ":", $facualty_code, "<br>";
            $group_category = null;
            if (count($cat_path) > 4) {
                $group_catid = $cat_path[3];
                $group_category = $DB->get_record('course_categories', array('id' => $group_catid));
            }
            $ccode = '20'.$fcode.$lesson_group;
            echo "Categories Check:", "<br>";
            $termCat = check_category(
                $term_alt,
                $tcode, 0);
            $UniName = check_category(
                $faculty_category->name,
                $fcode, $termCat);
            $MainCategory = $UniName;
            if ($group_category) {
                $MainCategory = check_category(
                    $group_category->name,
                    $ccode, $UniName);
            }
            $course->category = $MainCategory;
            echo "-----------------------", "<br>";
            echo "Updating Course:", "<br>";
            // check_lesson($course);
            $msg = "درس  "."<span class='text-primary'>".$course->shortname."</span>"." با موفقیت انتقال یافت";
            echo $msg, "<br>";
            echo "===================================================", "<br>";

        }
    } catch (Exception $e) {
        $msg = "<span class='text-danger'>"." خطا در ثبت درس به شماره ".$lesson->idnumber.
            "</span><br> <span class='text-danger text-left'>ERROR: "
            .$e->getMessage()."</span>";
        echo $msg;
    }

}

function check_lesson($lesson)
{
    global $DB;

    try {
        update_course($lesson);

    } catch (Exception $e) {
        throw new Exception($e->getMessage(), $e->getCode());
    }

}

function check_category($catname, $catidnumber, $parent)
{
    global $DB;
    try {
        $category = $DB->get_record('course_categories', array('idnumber' => $catidnumber));
        echo $catidnumber, " -> ", $catname, "<br>";
        if (!$category) {
            echo "Category Created.", "<br>";
            $data = new stdClass();
            $data->parent = $parent;
            $data->name = $catname;
            $data->idnumber = $catidnumber;

            $category = core_course_category::create($data);
        }
        echo "/////////////", "<br>";
        return $category->id;
    } catch (Exception $e) {
        throw new Exception($e->getMessage(), $e->getCode());

    }

}
